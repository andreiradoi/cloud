#+BEGIN_SRC sql :engine postgresql :exports results :cmdline -h 127.0.0.1 -U fieldkit

CREATE OR REPLACE VIEW fieldkit.project_and_station_activity AS
	SELECT sa.created_at, ps.project_id, sa.station_id, sa.id AS station_activity_id, NULL AS project_activity_id FROM
			fieldkit.project_station AS ps
	   JOIN fieldkit.station_activity AS sa ON (ps.station_id = sa.station_id)
	UNION
	SELECT pa.created_at, pa.project_id, NULL, NULL, pa.id AS project_activity_id FROM
		   fieldkit.project_activity AS pa;

SELECT * FROM fieldkit.project_and_station_activity;

#+END_SRC

#+RESULTS:
| CREATE VIEW                |            |            |                     |                     |
|----------------------------+------------+------------+---------------------+---------------------|
| created_at                 | project_id | station_id | station_activity_id | project_activity_id |
| 2020-04-24 17:42:51.568139 |          1 |          1 |                   1 |                     |
| 2020-04-24 17:42:51.575901 |          1 |          1 |                   2 |                     |
| 2020-04-24 17:50:31.004445 |          1 |            |                     |                   1 |

#+BEGIN_SRC sql :engine postgresql :exports results :cmdline -h 127.0.0.1 -U fieldkit

insert into fieldkit.project_station (project_id, station_id) values (1, 1) on conflict do nothing;
insert into fieldkit.project_update  (created_at, project_id, author_id, body) values (now(), 1, 2, 'Hello!');
insert into fieldkit.station_ingestion (created_at, station_id, uploader_id, data_ingestion_id, data_records, errors) values (now(), 1, 2, 15, 100, false);
insert into fieldkit.station_deployed  (created_at, station_id, deployed_at, location) values (now(), 1, now(), st_setsrid(st_point(-71.104, 42.315), 4326));
/*
insert into fieldkit.project_station_activity (created_at, project_id, station_activity_id) values ('2020-04-22 18:51:56.583585', 1, 1);
insert into fieldkit.project_station_activity (created_at, project_id, station_activity_id) values ('2020-04-22 18:51:56.583585', 1, 2);
*/

#+END_SRC

#+RESULTS:
| INSERT 0 1 |
|------------|
| INSERT 0 1 |
| INSERT 0 1 |
| INSERT 0 1 |

#+BEGIN_SRC sql :engine postgresql :exports results :cmdline -h 127.0.0.1 -U fieldkit

SELECT *
         FROM fieldkit.station_activity AS a
	LEFT JOIN fieldkit.station_deployed AS sd ON (a.id = sd.id)
	LEFT JOIN fieldkit.station_ingestion AS si ON (a.id = si.id)
	ORDER BY a.created DESC

#+END_SRC

#+RESULTS:

#+BEGIN_SRC sql :engine postgresql :exports results :cmdline -h 127.0.0.1 -U fieldkit

SELECT u.id AS user_id, u.name AS user, p.id AS project_id, p.name AS project_name
         FROM fieldkit.user AS u
	LEFT JOIN fieldkit.project_user AS pu ON (pu.user_id = u.id)
	LEFT JOIN fieldkit.project AS p ON (p.id = pu.project_id)
	ORDER BY user_id, project_id

#+END_SRC

#+RESULTS:
| user_id | user             | project_id | project_name             |
|---------+------------------+------------+--------------------------|
|       1 | Demo User        |            |                          |
|       2 | Jacob Lewallen   |          7 | Default FieldKit Project |
|       3 | Test User        |            |                          |
|       4 | NewPerson        |            |                          |
|       5 | Shah Selbe       |          8 | Default FieldKit Project |
|       5 | Shah Selbe       |         16 | Moore Demo               |
|       6 | Libbey White     |          5 | FieldKit Project         |
|       6 | Libbey White     |         17 | Snails                   |
|       7 | Felicia Chang    |            |                          |
|       8 | Bradley Gawthrop |            |                          |
|      10 | Tester           |            |                          |
|      14 | Kristi Cervania  |          6 | Default FieldKit Project |
|      15 | Lauren McElroy   |         14 | Default FieldKit Project |
|      16 | Susan Allen      |         10 | Default FieldKit Project |
|      16 | Susan Allen      |         22 | Susan's Test Project     |
|      18 | Kristi-Test      |            |                          |
|      19 | Jer Thorp        |          9 | Default FieldKit Project |
|      20 | Graeme           |         15 | Default FieldKit Project |
|      21 | Ricky            |            |                          |
|      22 | Paulo            |         24 | Default FieldKit Project |
|      25 | Ricky            |            |                          |
|      27 | Libbey           |            |                          |
|      28 | susantest        |            |                          |

#+BEGIN_SRC sql :engine postgresql :exports results :cmdline -h 127.0.0.1 -U fieldkit

SELECT s.id AS station_id, s.name AS station_name, o.id AS owner_id, o.name AS owner, p.id AS project_id, p.name AS project_name
		 FROM fieldkit.station AS s
    LEFT JOIN fieldkit.user AS o ON (s.owner_id = o.id)
	LEFT JOIN fieldkit.project_station AS ps ON (ps.station_id = s.id)
	LEFT JOIN fieldkit.project AS p ON (p.id = ps.project_id)
	 ORDER BY station_id, project_id

#+END_SRC

#+RESULTS:
| station_id | station_name           | owner_id | owner            | project_id | project_name             |
|------------+------------------------+----------+------------------+------------+--------------------------|
|          1 | feldspar               |       10 | Tester           |            |                          |
|          3 | quartz                 |       10 | Tester           |          1 | Demo Project             |
|         13 | Friendly Horse 11      |        2 | Jacob Lewallen   |            |                          |
|         15 | Quiet Catfish 86       |        2 | Jacob Lewallen   |            |                          |
|         16 | Formal Mayfly 65       |        2 | Jacob Lewallen   |            |                          |
|         19 | Stupid Sloth 44        |        2 | Jacob Lewallen   |            |                          |
|        154 | Vibrant Lizard 98      |        6 | Libbey White     |          5 | FieldKit Project         |
|        159 | Admired Goose 81       |        2 | Jacob Lewallen   |            |                          |
|        162 | Green Zebra 85         |        8 | Bradley Gawthrop |            |                          |
|        163 | Tender Dog 79          |        2 | Jacob Lewallen   |            |                          |
|        164 | Breezy Stingray 71     |       15 | Lauren McElroy   |            |                          |
|        165 | Brown Dodo 10          |        5 | Shah Selbe       |            |                          |
|        169 | mica                   |        6 | Libbey White     |         17 | Snails                   |
|        170 | Massive Jellyfish 86   |        2 | Jacob Lewallen   |            |                          |
|        171 | Noteworthy Warthog 54  |        5 | Shah Selbe       |            |                          |
|        172 | Tremendous Stingray 21 |        5 | Shah Selbe       |            |                          |
|        173 | Impressive Hound 101   |       20 | Graeme           |         15 | Default FieldKit Project |
|        174 | Huge Falcon 36         |       16 | Susan Allen      |         10 | Default FieldKit Project |
|        174 | Huge Falcon 36         |       16 | Susan Allen      |         22 | Susan's Test Project     |
|        175 | Pleasant Jellyfish 60  |       15 | Lauren McElroy   |            |                          |
|        176 | Calm Panda 40          |       15 | Lauren McElroy   |            |                          |
|        177 | Bewitched Husky 17     |        5 | Shah Selbe       |          8 | Default FieldKit Project |
|        177 | Bewitched Husky 17     |        5 | Shah Selbe       |         16 | Moore Demo               |
|        178 | Ambitious Stingray 65  |        5 | Shah Selbe       |            |                          |
|        179 | super panda            |       22 | Paulo            |         24 | Default FieldKit Project |
|        180 | Lucky Sloth 2          |        5 | Shah Selbe       |            |                          |
|        181 | Highland Park Selbe    |        5 | Shah Selbe       |            |                          |


#+BEGIN_SRC sql :engine postgresql :exports results :cmdline -h 127.0.0.1 -U fieldkit

UPDATE fieldkit.project SET name = 'Demo Project' WHERE id = 1;
INSERT INTO fieldkit.project_station (project_id, station_id) VALUES (1, 12) ON CONFLICT DO NOTHING;
INSERT INTO fieldkit.project_user (project_id, user_id) VALUES (1, 26) ON CONFLICT DO NOTHING;

#+END_SRC

#+RESULTS:
| UPDATE 1 |
|----------|

#+BEGIN_SRC sql :engine postgresql :exports results :cmdline -h 127.0.0.1 -U fieldkit

SELECT ST_Buffer(ST_GeomFromText('POINT(1 1)'), 10) ~ ST_MakeBox2D(ST_MakePoint(0,0), ST_MakePoint(2,2)) AS contains;

#+END_SRC

#+RESULTS:
| contains |
|----------|
| t        |


#+BEGIN_SRC sql :engine postgresql :exports results :cmdline -h 127.0.0.1 -U fieldkit

SELECT * FROM fieldkit.project_and_station_activity ORDER BY created_at DESC;

		SELECT
			a.id, a.created_at, a.station_id, a.deployed_at, ST_AsBinary(a.location) AS location
		FROM fieldkit.station_deployed AS a
		WHERE a.id IN (

			SELECT station_activity_id FROM fieldkit.project_and_station_activity WHERE (1 IS NULL OR project_id = 1) AND (1 IS NULL OR station_id = 1) ORDER BY created_at DESC

		)

#+END_SRC

#+RESULTS:
| created_at                 |                 project_id | station_id | station_activity_id        | project_activity_id                          |
|----------------------------+----------------------------+------------+----------------------------+----------------------------------------------|
| 2020-04-24 18:04:39.921296 |                          1 |          1 | 2                          |                                              |
| 2020-04-24 18:04:39.916216 |                          1 |          1 | 1                          |                                              |
| 2020-04-24 18:04:39.911111 |                          1 |            |                            | 1                                            |
| id                         |                 created_at | station_id | deployed_at                | location                                     |
| 2                          | 2020-04-24 18:04:39.921296 |          1 | 2020-04-24 18:04:39.921296 | \x01010000002db29defa7c651c0b81e85eb51284540 |
